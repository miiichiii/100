
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>解剖学100問テスト</title>
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: 0 auto; }
    h1, h2, h3 { text-align: center; }
    button {
      padding: 0.75em 1.5em; font-size: 1em;
      border: none; border-radius: 4px; cursor: pointer;
      display: block; margin: 1em auto;
      transition: background-color 0.3s;
    }
    #loginButton { background: #00c300; color: #fff; }
    button:disabled { background: #888; cursor: default; opacity: 0.7; }
    #loginStatus { margin-top: 1em; text-align: center; }
    #login-container { text-align: center; }

    /* --- クイズ用のスタイル --- */
    #quiz-container { display: none; }
    #question-image { 
      width: 100%; max-width: 500px; height: auto; 
      display: block; margin: 1em auto; border: 1px solid #ccc;
    }
    #question-text { font-size: 1.2em; font-weight: bold; margin-bottom: 1em; text-align: center;}
    #choices { 
      display: flex; justify-content: center; 
      gap: 10px; margin-bottom: 1em; flex-wrap: wrap;
    }
    #choices button { 
      width: 60px; height: 60px; margin: 0; 
      background-color: #007bff; color: white; font-size: 1.5em;
    }
    /* ▼▼▼ 正解・不正解用のスタイルを追加 ▼▼▼ */
    #choices button.correct { background-color: #28a745; } /* 正解: 緑 */
    #choices button.incorrect { background-color: #dc3545; } /* 不正解: 赤 */
    /* ▲▲▲ 正解・不正解用のスタイルを追加 ▲▲▲ */

    #next-button { background-color: #6c757d; color: white; }
    #quiz-result { text-align: center; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <div id="login-container">
    <h1>解剖学 100問テスト</h1>
    <button id="loginButton" disabled>LINEでログイン</button>
    <div id="loginStatus">読み込み中…</div>
  </div>

  <div id="quiz-container">
    <h2 id="question-number"></h2>
    <img id="question-image" src="" alt="問題画像">
    <p id="question-text"></p>
    <div id="choices"></div>
    <button id="next-button">次の問題へ</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      OAuthProvider, signInWithCredential
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    const firebaseConfig = { /* ... 先生の設定をここに ... */ };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence).catch(console.error);

    const LIFF_ID = "2007823353-JEORYMGm";
    const loginContainer = document.getElementById("login-container");
    const loginButton    = document.getElementById("loginButton");
    const loginStatus    = document.getElementById("loginStatus");
    const quizContainer  = document.getElementById("quiz-container");
    const questionNumber = document.getElementById("question-number");
    const questionImage  = document.getElementById("question-image");
    const questionText   = document.getElementById("question-text");
    const choicesContainer = document.getElementById("choices");
    const nextButton     = document.getElementById("next-button");
    const provider       = new OAuthProvider("oidc.line");

    let allQuizData = [];
    let currentQuestionIndex = 0;
    let score = 0; // スコアを記録する変数を追加

    async function loadQuizData() {
        try {
            const response = await fetch('./quiz_data_final.csv');
            if (!response.ok) throw new Error(`CSVの読み込みエラー: ${response.statusText}`);
            
            const csvText = await response.text();
            const lines = csvText.trim().split('\n');
            lines.shift(); // ヘッダー行を読み飛ばす

            allQuizData = lines.map(line => {
                const [id, img, text, cat, ans] = line.split(',');
                return {
                    questionId: id,
                    imageName: img,
                    questionText: text,
                    category: cat,
                    correctAnswer: parseInt(ans, 10)
                };
            }).filter(item => item && item.correctAnswer);
            
            if (allQuizData.length === 0) throw new Error('有効なクイズデータがありません。');
        } catch (error) {
            console.error(error);
            quizContainer.innerHTML = `<p style="color:red; text-align:center;">${error.message}</p>`;
            quizContainer.style.display = 'block';
        }
    }

    /**
     * 解答をチェックし、フィードバックとスコア加算を行う
     */
    function checkAnswer(selectedIndex, correctAnswer) {
      const choiceButtons = choicesContainer.querySelectorAll('button');
      let isCorrect = (selectedIndex === correctAnswer);

      if (isCorrect) {
        score++; // 正解ならスコアを加算
      }

      // 全てのボタンを無効化
      choiceButtons.forEach(btn => {
        btn.disabled = true;
        const btnIndex = parseInt(btn.textContent);
        
        if (btnIndex === correctAnswer) {
          // 正解のボタンを緑にする
          btn.classList.add('correct');
        }
        
        if (btnIndex === selectedIndex && !isCorrect) {
          // 不正解の場合、選択したボタンを赤にする
          btn.classList.add('incorrect');
        }
      });
    }

    function displayQuestion() {
      const quiz = allQuizData[currentQuestionIndex];
      questionNumber.textContent = `問題 ${currentQuestionIndex + 1} / ${allQuizData.length}`;
      questionImage.src = `./images/${quiz.imageName}`;
      questionImage.alt = quiz.questionText;
      questionText.textContent = quiz.questionText;
      choicesContainer.innerHTML = '';

      for (let i = 1; i <= 5; i++) {
        const button = document.createElement('button');
        button.textContent = i;
        button.onclick = () => {
          // ▼▼▼ 解答チェック関数を呼び出すように変更 ▼▼▼
          checkAnswer(i, quiz.correctAnswer);
        };
        choicesContainer.appendChild(button);
      }
      
      if (currentQuestionIndex >= allQuizData.length - 1) {
        nextButton.textContent = '結果を見る';
      } else {
        nextButton.textContent = '次の問題へ';
      }
    }
    
    nextButton.addEventListener('click', () => {
      currentQuestionIndex++;
      if (currentQuestionIndex < allQuizData.length) {
        displayQuestion();
      } else {
        // ▼▼▼ 最終スコアを表示するように変更 ▼▼▼
        quizContainer.innerHTML = `
          <div id="quiz-result">
            <h2>テスト終了</h2>
            <p>お疲れ様でした！</p>
            <h3>あなたのスコア: ${score} / ${allQuizData.length}</h3>
          </div>
        `;
      }
    });

    async function startQuiz(user) {
      loginStatus.innerHTML = `ようこそ、<strong>${user.displayName}</strong> さん。`;
      await loadQuizData();
      if (allQuizData.length > 0) {
        loginContainer.style.display = 'none';
        quizContainer.style.display = 'block';
        displayQuestion();
      }
    }

    // LIFF初期化とログイン処理... (変更なし)
    liff.init({ liffId: LIFF_ID }).then(() => {
        loginStatus.textContent = "";
        loginButton.disabled = false;
        loginButton.addEventListener("click", () => {
          if (!liff.isLoggedIn()) {
            liff.login({ redirectUri: location.href });
            return;
          }
          const idToken = liff.getIDToken();
          if (!idToken) { return; }
          const cred = provider.credential({ idToken });
          signInWithCredential(auth, cred)
            .then(res => startQuiz(res.user))
            .catch(err => {
              console.error("Firebase認証エラー:", err);
              loginStatus.textContent = `ログイン失敗: ${err.code}`;
            });
        });
    }).catch(err => {
        console.error("LIFF初期化エラー:", err);
        loginStatus.textContent = "読み込みに失敗しました";
    });
  </script>
</body>
</html>
