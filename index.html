<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>解剖学100問テスト</title>
</head>
<body>
    <h1>解剖学 100問テスト</h1>
    
    <button id="loginButton" style="display: none;">LINEでログイン</button>
    <div id="loginStatus">ログイン状態を確認中...</div>

    <div id="quizContainer" style="display: none;">
        <p>ここにクイズが表示されます。</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithRedirect, 
            getRedirectResult, 
            OAuthProvider 
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyBXZwP73c-qOVEi6EA7Wj0006RRR26EEtk",
            authDomain: "attendance-fe914.firebaseapp.com",
            projectId: "attendance-fe914",
            storageBucket: "attendance-fe914.firebasestorage.app",
            messagingSenderId: "367627549934",
            appId: "1:367627549934:web:86d748f89def69d94607ff",
            measurementId: "G-1S24B3BCK0"
        };

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // HTML要素の取得
        const loginButton = document.getElementById('loginButton');
        const loginStatus = document.getElementById('loginStatus');
        const quizContainer = document.getElementById('quizContainer');

        // ログインボタンのクリック処理
        loginButton.addEventListener('click', () => {
            const provider = new OAuthProvider('oidc.line');
            signInWithRedirect(auth, provider);
        });

        // ★★★ 認証状態を監視するリスナー（監視役） ★★★
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // ユーザーがログインしている場合の処理
                console.log("ログイン中のユーザー:", user);
                loginStatus.innerHTML = `ようこそ、<strong>${user.displayName ?? '学生'}</strong> さん`;
                loginButton.style.display = 'none'; // ログインボタンを隠す
                quizContainer.style.display = 'block'; // クイズコンテンツを表示
            } else {
                // ユーザーがログインしていない場合の処理
                console.log("ユーザーはログインしていません。");
                loginStatus.textContent = 'ログインしてください。';
                loginButton.style.display = 'block'; // ログインボタンを表示
                quizContainer.style.display = 'none'; // クイズコンテンツを隠す
            }
        });

        // リダイレクトからの戻りを処理（エラーハンドリングが主目的）
        getRedirectResult(auth).catch((error) => {
            console.error('リダイレクト処理エラー:', error);
            loginStatus.textContent = `ログイン処理中にエラーが発生しました: ${error.code}`;
        });
    </script>
</body>
</html>
