<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>解剖学100問テスト</title>
  <style>
    /* CSSは変更ありません */
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: 0 auto; }
    h1, h2, h3 { text-align: center; }
    button { padding: 0.75em 1.5em; font-size: 1em; border: none; border-radius: 4px; cursor: pointer; display: block; margin: 1em auto; transition: background-color 0.3s; }
    button:disabled { background: #888; cursor: default; opacity: 0.7; }
    #login-container { text-align: center; margin-top: 2em;}
    #loginStatus { margin-top: 1em; text-align: center; }
    #user-display { display: none; text-align: right; padding: 0.5em 1em; margin-bottom: 1em; font-size: 0.9em; color: #000; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; }
    #quiz-container { display: none; }
    #question-image { width: 100%; max-width: 500px; height: auto; display: block; margin: 1em auto; border: 1px solid #ccc; }
    #question-text { font-size: 1.2em; font-weight: bold; margin-bottom: 1em; text-align: center;}
    #choices { display: flex; justify-content: center; gap: 10px; margin-bottom: 1em; flex-wrap: wrap; }
    #choices button { width: 60px; height: 60px; margin: 0; background-color: #007bff; color: white; font-size: 1.5em; }
    #choices button.correct { background-color: #28a745 !important; }
    #choices button.incorrect { background-color: #dc3545 !important; }
    #next-button { background-color: #6c757d; color: white; }
    #quiz-result { text-align: center; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

  <div id="user-display"></div>
  <div id="login-container">
    <h1>解剖学 100問テスト</h1>
    <div id="loginStatus">ユーザー情報を確認中…</div>
  </div>
  <div id="quiz-container">
    <h2 id="question-number"></h2>
    <img id="question-image" src="" alt="問題画像">
    <p id="question-text"></p>
    <div id="choices"></div>
    <button id="next-button">次の問題へ</button>
  </div>


  <script type="module">
    // ▼▼▼ Firestore関連の機能をインポート ▼▼▼
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      OAuthProvider, signInWithCredential
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    // --- Firebase 設定 ---
    const firebaseConfig = {
      apiKey: "AIzaSyBXZwP73c-qOvEi6EA7Wj0O06RRR26EEtk",
      authDomain: "attendance-fe914.firebaseapp.com",
      projectId: "attendance-fe914",
      storageBucket: "attendance-fe914.firebasestorage.app",
      messagingSenderId: "367627549934",
      appId: "1:367627549934:web:86d748f89def69d94607ff",
      measurementId: "G-1S24B3BCKD"
    };

    // --- 初期化処理 ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app); // Firestoreのインスタンスを取得
    setPersistence(auth, browserLocalPersistence).catch(console.error);

    // (DOM要素の取得、クイズ変数の宣言などは変更なし)
    const LIFF_ID = "2007823353-JEORYMGm";
    const userDisplay = document.getElementById("user-display"); 
    const loginContainer = document.getElementById("login-container");
    const loginStatus    = document.getElementById("loginStatus");
    const quizContainer  = document.getElementById("quiz-container");
    // ... (以下、他の要素取得も同じ)

    let currentUser = null; // ログインユーザー情報を保持する変数
    let allQuizData = [], currentQuestionIndex = 0, score = 0, answered = false;
    
    // (loadQuizData, checkAnswer, displayQuestion関数は変更なし)

    // ▼▼▼ 結果をFirestoreに保存する関数を新設 ▼▼▼
    async function saveResult() {
      if (!currentUser) return; // ユーザー情報がなければ何もしない

      const resultData = {
        displayName: currentUser.displayName,
        score: score,
        totalQuestions: allQuizData.length,
        completedAt: serverTimestamp() // 保存した日時を記録
      };

      try {
        // 'results'コレクションに、ユーザーIDをドキュメントIDとしてデータを保存
        const docRef = doc(db, 'results', currentUser.uid);
        await setDoc(docRef, resultData, { merge: true }); // 既存データにマージ
        console.log("成績を保存しました。");
      } catch (error) {
        console.error("成績の保存に失敗しました:", error);
      }
    }

    // --- 「次の問題へ」ボタンの処理を修正 ---
    nextButton.addEventListener('click', async () => { // asyncを追加
      currentQuestionIndex++;
      if (currentQuestionIndex < allQuizData.length) {
        displayQuestion();
      } else {
        // ▼▼▼ クイズ終了時に保存処理を呼び出す ▼▼▼
        await saveResult(); 
        
        quizContainer.innerHTML = `
          <div id="quiz-result">
            <h2>テスト終了</h2>
            <p>お疲れ様でした！成績を記録しました。</p>
            <h3>あなたのスコア: ${score} / ${allQuizData.length}</h3>
          </div>
        `;
      }
    });

    // --- メインの処理（LIFF初期化とログイン）を修正 ---
    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: location.href });
          return;
        }
        const idToken = liff.getIDToken();
        if (!idToken) throw new Error('LINEのIDトークンを取得できませんでした。');
        
        const cred = provider.credential({ idToken });
        const result = await signInWithCredential(auth, cred);
        
        // ▼▼▼ ログインしたユーザー情報を変数に保持 ▼▼▼
        currentUser = result.user; 
        
        // ユーザー名表示、クイズ開始 (変更なし)
        userDisplay.innerHTML = `ようこそ、<strong>${currentUser.displayName}</strong> さん`;
        userDisplay.style.display = 'block'; 
        loginContainer.style.display = 'none';
        
        await loadQuizData();
        if (allQuizData.length > 0) {
          quizContainer.style.display = 'block';
          displayQuestion();
        }
      } catch (err) {
        console.error("処理エラー:", err);
        loginStatus.innerHTML = `<span style="color:red;">エラーが発生しました: ${err.message}</span>`;
      }
    }

    main();
  </script>
</body>
</html>
